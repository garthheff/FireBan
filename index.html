<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Trail fire ban guide</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
/* --- unchanged CSS --- */
body { font-family: system-ui; padding:16px }
.box { padding:10px; border:1px solid #ddd; border-radius:8px; margin:12px 0 }
.warn { background:#fff3cd }
.ok { background:#e7f6ee }
.err { background:#fde2e1 }
.small { font-size:0.9rem }
tr.closed { background:#ffcccc }
tr.open { background:#d7f7df }
tr.maybe { background:#fff3cd }
#map { height:360px; border-radius:14px }
</style>
</head>

<body>
<h1>Trail fire ban guide</h1>

<div class="box warn small">
All calculations use <strong>Australia/Adelaide</strong> timezone (DST-aware)
</div>

<div class="day-section">
  <h2>Today <span id="todayDate"></span></h2>
  <table border="1" width="100%">
    <thead>
      <tr>
        <th>Trail</th><th>Region</th><th>Owner</th>
        <th>Fire danger</th><th>Fire ban</th>
        <th>Closed on</th><th>Closed</th>
      </tr>
    </thead>
    <tbody id="rowsToday"></tbody>
  </table>
</div>

<div class="day-section">
  <h2>Tomorrow <span id="tomorrowDate"></span></h2>
  <table border="1" width="100%">
    <tbody id="rowsTomorrow"></tbody>
  </table>
</div>

<div id="status" class="box warn small">Loadingâ€¦</div>

<script>
const TRAILS_URL = "./trails.json"
const XML_URL = "https://data.eso.sa.gov.au/prod/cfs/criimson/fireDangerRating.xml"

const tbodyToday = document.getElementById("rowsToday")
const tbodyTomorrow = document.getElementById("rowsTomorrow")
const todayDateEl = document.getElementById("todayDate")
const tomorrowDateEl = document.getElementById("tomorrowDate")
const statusEl = document.getElementById("status")

let trailsData = []
let forecastBase = new Map()
let allRows = []

function setStatus(kind, msg) {
  statusEl.className = "box " + kind + " small"
  statusEl.textContent = msg
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
}

function nextTwoDays() {
  const fmt = new Intl.DateTimeFormat("en-CA", {
    timeZone: "Australia/Adelaide",
    year: "numeric",
    month: "2-digit",
    day: "2-digit"
  })

  const now = new Date()

  return [0,1].map(i => {
    const d = new Date(now.getTime() + i * 86400000)
    return fmt.format(d)
  })
}

function parseXml(xmlDoc) {
  const map = new Map()

  for (const area of xmlDoc.querySelectorAll("area")) {
    const region = area.getAttribute("description")
    const byDate = new Map()

    for (const fp of area.querySelectorAll("forecast-period")) {
      const date = fp.getAttribute("start-time-local")?.slice(0,10)
      const texts = fp.querySelectorAll("text")

      if (!date) continue

      byDate.set(date, {
        rating: texts[0]?.textContent.trim() || "-",
        tfbYes: texts[1]?.textContent.trim() === "true"
      })
    }

    map.set(region, byDate)
  }

  return map
}

function computeClosed(tfb, rating, ban) {
  if (!tfb) return "No"
  if (ban === "Total Fire Ban") return "Yes"
  if (rating === ban) return "Yes"
  if (rating === "Extreme") return "Maybe"
  return "No"
}

function rebuildRows() {
  const [today, tomorrow] = nextTwoDays()
  todayDateEl.textContent = today
  tomorrowDateEl.textContent = tomorrow

  const rows = []

  for (const t of trailsData) {
    for (const d of [today, tomorrow]) {
      const f = forecastBase.get(t.region)?.get(d) || { rating:"-", tfbYes:false }
      rows.push({
        date:d,
        trail:t.name,
        region:t.region,
        owner:t.owner,
        fireDanger:f.rating,
        fireBan:f.tfbYes ? "Yes" : "No",
        closedOn:t.ban,
        closed:computeClosed(f.tfbYes,f.rating,t.ban)
      })
    }
  }

  allRows = rows
  render()
  setStatus("ok","Loaded "+rows.length+" rows")
}

function render() {
  tbodyToday.innerHTML = ""
  tbodyTomorrow.innerHTML = ""

  for (const r of allRows) {
    const tr = document.createElement("tr")
    tr.className = r.closed === "Yes" ? "closed" : r.closed === "Maybe" ? "maybe" : "open"

    tr.innerHTML =
      `<td>${escapeHtml(r.trail)}</td>
       <td>${escapeHtml(r.region)}</td>
       <td>${escapeHtml(r.owner)}</td>
       <td>${escapeHtml(r.fireDanger)}</td>
       <td>${escapeHtml(r.fireBan)}</td>
       <td>${escapeHtml(r.closedOn)}</td>
       <td>${escapeHtml(r.closed)}</td>`

    if (r.date === todayDateEl.textContent) tbodyToday.appendChild(tr)
    else tbodyTomorrow.appendChild(tr)
  }
}

async function main() {
  try {
    setStatus("warn","Loading trails.json")
    trailsData = (await (await fetch(TRAILS_URL)).json()).trails || []

    setStatus("warn","Loading CFS XML")
    const xml = await (await fetch(XML_URL)).text()
    const xmlDoc = new DOMParser().parseFromString(xml,"application/xml")

    forecastBase = parseXml(xmlDoc)
    rebuildRows()
  } catch (e) {
    setStatus("err","Load failed: "+e.message)
  }
}

main()
</script>
</body>
</html>
