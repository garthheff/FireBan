<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Trail fire ban guide</title>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding: 16px;
    }

    .box {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 12px 0;
    }

    .warn { background: #fff3cd; border-color: #ffeeba; }
    .ok   { background: #e7f6ee; border-color: #bfe8cf; }
    .err  { background: #fde2e1; border-color: #f5b5b3; }

    .small { font-size: 0.9rem; }

    .topbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .topbar input {
      flex: 1 1 320px;
      max-width: none;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .ctrl {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      flex: 0 0 auto;
    }

    .menu {
      position: relative;
      display: inline-block;
    }

    .menu-panel {
      position: absolute;
      z-index: 5;
      right: 0;
      top: 100%;
      margin-top: 6px;
      min-width: 220px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      padding: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      display: none;
    }

    .menu-panel.open { display: block; }

    .cols {
      display: grid;
      gap: 8px;
    }

    .cols label {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .col-hidden { display: none; }

    .trailcell {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .trailactions {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .trailactions a,
    .trailactions button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 0;
      padding: 2px;
      border-radius: 6px;
    }

    .trailactions button {
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
    }

    .trailactions button:hover { background: #f3f3f3; }

    .trailicon {
      width: 18px;
      height: 18px;
    }

    .infoicon {
      width: 18px;
      height: 18px;
      color: #1e88e5;
    }

    .hidden-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid #ddd;
      border-radius: 999px;
      padding: 6px 10px;
      background: #fff;
    }

    .pill button {
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 999px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .pill button:hover { background: #f3f3f3; }

    .day-section {
      margin-top: 14px;
    }

    .day-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 12px;
      background: #f6f6f6;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .day-header .date {
      font-weight: 600;
      opacity: 0.85;
    }

    .day-gap {
      height: 14px;
    }

    .tablewrap {
      border: 1px solid #ddd;
      border-radius: 14px;
      overflow: hidden;
      background: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #f6f6f6;
      z-index: 1;
    }

    tr.closed { background: #ffcccc; }
    tr.open   { background: #d7f7df; }
    tr.maybe  { background: #fff3cd; }

    #testBox button {
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      border-radius: 8px;
      padding: 8px 10px;
    }

    #testBox button:hover { background: #f3f3f3; }
  </style>
</head>

<body>
  <h1>Trail fire ban guide</h1>

  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="trailforks-icon" viewBox="0 0 300 300">
      <polygon points="150 20 0 279 300 279" fill="#FFCE07"></polygon>
      <path d="M198 257.5 L171.5 257 L171.5 200 L151 184.5 L148 184.5 L127.5 200 L127.5 257 L100.5 257 L100.5 200 L133.5 164 L134 91.5 L165.5 92 L165.5 164 L198.5 188 Z" fill="currentColor"></path>
    </symbol>

    <symbol id="x-icon" viewBox="0 0 24 24">
      <path d="M18.3 5.7 L5.7 18.3 M5.7 5.7 L18.3 18.3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
    </symbol>

    <symbol id="info-icon" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10" fill="currentColor"></circle>
      <rect x="11" y="10" width="2" height="7" fill="#fff"></rect>
      <circle cx="12" cy="7" r="1.2" fill="#fff"></circle>
    </symbol>
  </svg>

  <div class="box warn small">
    Total fire bans officially start at midnight 00:00 for 24hrs. Fire Danger Ratings are routinely issued by 5pm daily during the fire season. These ratings are determined in conjunction with Bureau of Meteorology.
  </div>

  <div class="box warn small">
    This tool has been rewritten and is untested with live data so best to double check results
  </div>

  <div class="topbar">
    <input id="q" type="text" placeholder="Search trail, region, owner">

    <div class="ctrl">
      <strong>Sort</strong>
      <select id="sortKey">
        <option value="trail">Trail</option>
        <option value="region">Region</option>
        <option value="owner">Owner</option>
        <option value="fireDanger">Fire danger</option>
        <option value="fireBan">Fire ban</option>
        <option value="closedOn">Closed on</option>
        <option value="closed">Closed</option>
      </select>

      <select id="sortMode">
        <option value="az">A to Z</option>
        <option value="za">Z to A</option>
      </select>
    </div>

    <div class="ctrl menu">
      <button id="colsBtn" type="button">Columns</button>
      <div id="colsPanel" class="menu-panel" aria-label="Column picker">
        <div class="cols">
          <label><input type="checkbox" data-col="trail" checked> Trail</label>
          <label><input type="checkbox" data-col="region" checked> Region</label>
          <label><input type="checkbox" data-col="owner" checked> Owner</label>
          <label><input type="checkbox" data-col="fireDanger" checked> Fire danger</label>
          <label><input type="checkbox" data-col="fireBan" checked> Fire ban</label>
          <label><input type="checkbox" data-col="closedOn" checked> Closed on</label>
          <label><input type="checkbox" data-col="closed" checked> Closed</label>
        </div>

        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
          <button id="colsAll" type="button">Show all</button>
          <button id="colsNone" type="button">Hide all</button>
        </div>
      </div>
    </div>
  </div>

  <div class="day-section">
    <div class="day-header">
      <div id="todayLabel">Today</div>
      <div id="todayDate" class="date"></div>
    </div>

    <div class="tablewrap">
      <table>
        <thead>
          <tr>
            <th data-col="trail">Trail</th>
            <th data-col="region">Region</th>
            <th data-col="owner">Owner</th>
            <th data-col="fireDanger">Fire danger</th>
            <th data-col="fireBan">Fire ban</th>
            <th data-col="closedOn">Closed on</th>
            <th data-col="closed">Closed</th>
          </tr>
        </thead>
        <tbody id="rowsToday"></tbody>
      </table>
    </div>
  </div>

  <div class="day-gap"></div>

  <div class="day-section">
    <div class="day-header">
      <div id="tomorrowLabel">Tomorrow</div>
      <div id="tomorrowDate" class="date"></div>
    </div>

    <div class="tablewrap">
      <table>
        <thead>
          <tr>
            <th data-col="trail">Trail</th>
            <th data-col="region">Region</th>
            <th data-col="owner">Owner</th>
            <th data-col="fireDanger">Fire danger</th>
            <th data-col="fireBan">Fire ban</th>
            <th data-col="closedOn">Closed on</th>
            <th data-col="closed">Closed</th>
          </tr>
        </thead>
        <tbody id="rowsTomorrow"></tbody>
      </table>
    </div>
  </div>

  <div id="status" class="box warn small">Loadingâ€¦</div>

  <div id="hiddenBox" class="box warn small" style="display:none">
    <div><strong>Hidden trails</strong></div>
    <div id="hiddenList" class="hidden-list"></div>
    <div style="margin-top:8px">
      <button id="unhideAllBtn" type="button">Unhide all</button>
    </div>
  </div>

  <div id="testBox" class="box small" style="display:none">
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end">
      <div style="min-width:220px; flex:1 1 220px">
        <div><strong>Test region</strong></div>
        <select id="testRegion" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:8px"></select>
      </div>

      <div style="min-width:160px">
        <div><strong>Test date</strong></div>
        <select id="testDate" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:8px"></select>
      </div>

      <label class="ctrl" style="margin:0">
        <input id="testTfb" type="checkbox">
        <span><strong>Total fire ban</strong></span>
      </label>

      <div style="min-width:190px">
        <div><strong>Fire danger</strong></div>
        <select id="testRating" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:8px">
          <option value="None">None</option>
          <option value="Moderate">Moderate</option>
          <option value="High">High</option>
          <option value="Extreme">Extreme</option>
          <option value="Catastrophic">Catastrophic</option>
        </select>
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button id="testApply" type="button">Apply test</button>
        <button id="testReset" type="button">Reset tests</button>
      </div>
    </div>

    <div id="testNote" style="margin-top:8px; opacity:0.85"></div>
  </div>

  <script>
    const TRAILS_URL = "./trails.json"
    const XML_URL = "https://data.eso.sa.gov.au/prod/cfs/criimson/fireDangerRating.xml"

    const statusEl = document.getElementById("status")
    const q = document.getElementById("q")

    const tbodyToday = document.getElementById("rowsToday")
    const tbodyTomorrow = document.getElementById("rowsTomorrow")

    const todayDateEl = document.getElementById("todayDate")
    const tomorrowDateEl = document.getElementById("tomorrowDate")

    const hiddenBox = document.getElementById("hiddenBox")
    const hiddenListEl = document.getElementById("hiddenList")
    const unhideAllBtn = document.getElementById("unhideAllBtn")

    const sortKeyEl = document.getElementById("sortKey")
    const sortModeEl = document.getElementById("sortMode") || document.getElementById("sortDir")

    const colsBtn = document.getElementById("colsBtn")
    const colsPanel = document.getElementById("colsPanel")
    const colsAll = document.getElementById("colsAll")
    const colsNone = document.getElementById("colsNone")

    const testBox = document.getElementById("testBox")
    const testRegionEl = document.getElementById("testRegion")
    const testDateEl = document.getElementById("testDate")
    const testTfbEl = document.getElementById("testTfb")
    const testRatingEl = document.getElementById("testRating")
    const testApplyBtn = document.getElementById("testApply")
    const testResetBtn = document.getElementById("testReset")
    const testNoteEl = document.getElementById("testNote")

    const HIDDEN_COOKIE = "hidden_trails_v1"
    const PREFS_COOKIE = "trail_prefs_v1"

    let hidden = new Set()
    let allRows = []

    let trailsData = []
    let forecastBase = new Map()

    const overrides = new Map()

    let prefs = {
      sortKey: "trail",
      sortMode: "az",
      cols: {
        trail: true,
        region: true,
        owner: true,
        fireDanger: true,
        fireBan: true,
        closedOn: true,
        closed: true
      }
    }

    function setStatus(kind, msg) {
      statusEl.className = "box " + kind + " small"
      statusEl.textContent = msg
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;")
    }

    function nextTwoDays() {
      const now = new Date()
      return [0,1].map(i => {
        const d = new Date(now.getTime() + i * 86400000)
        return d.toISOString().slice(0,10)
      })
    }

    function isTotalFireBan(name) {
      return (name || "").trim() === "Total Fire Ban"
    }

    function computeClosed(tfbYes, rating, trailBan) {
      if (!tfbYes) return "No"
      if (isTotalFireBan(trailBan)) return "Yes"
      if ((rating || "") === (trailBan || "")) return "Yes"
      if (rating === "Extreme") return "Maybe"
      return "No"
    }

    function rowClass(v) {
      if (v === "Yes") return "closed"
      if (v === "Maybe") return "maybe"
      return "open"
    }

    function parseXml(xmlDoc) {
      const map = new Map()

      const areas = [...xmlDoc.querySelectorAll("area")]
        .filter(a => parseInt(a.getAttribute("districtID") || "0", 10) > 0)

      for (const area of areas) {
        const region = area.getAttribute("description")
        const byDate = new Map()

        for (const fp of area.querySelectorAll("forecast-period")) {
          const date = (fp.getAttribute("start-time-local") || "").slice(0,10)
          const texts = fp.querySelectorAll("text")

          const rating = texts[0]?.textContent.trim() || "-"
          const tfbYes = texts[1]?.textContent.trim() === "true"

          if (date) byDate.set(date, { rating, tfbYes })
        }

        map.set(region, byDate)
      }

      return map
    }

    function setCookie(name, value, days) {
      const d = new Date()
      d.setTime(d.getTime() + days * 86400000)
      document.cookie = name + "=" + encodeURIComponent(value) + "; expires=" + d.toUTCString() + "; path=/; SameSite=Lax"
    }

    function getCookie(name) {
      const parts = document.cookie.split(";")
      for (const p of parts) {
        const s = p.trim()
        if (s.startsWith(name + "=")) return decodeURIComponent(s.slice(name.length + 1))
      }
      return ""
    }

    function loadHidden() {
      try {
        const raw = getCookie(HIDDEN_COOKIE)
        if (!raw) return new Set()
        const arr = JSON.parse(raw)
        if (!Array.isArray(arr)) return new Set()
        return new Set(arr.map(x => String(x)))
      } catch {
        return new Set()
      }
    }

    function saveHidden() {
      const arr = [...hidden.values()].sort((a,b) => a.localeCompare(b))
      setCookie(HIDDEN_COOKIE, JSON.stringify(arr), 365)
    }

    function loadPrefs() {
      try {
        const raw = getCookie(PREFS_COOKIE)
        if (!raw) return null
        const obj = JSON.parse(raw)
        if (!obj || typeof obj !== "object") return null
        return obj
      } catch {
        return null
      }
    }

    function savePrefs() {
      setCookie(PREFS_COOKIE, JSON.stringify(prefs), 365)
    }

    function applyPrefsToUi() {
      sortKeyEl.value = prefs.sortKey || "trail"
      if (sortModeEl) sortModeEl.value = prefs.sortMode || "az"

      for (const cb of colsPanel.querySelectorAll("input[type=checkbox][data-col]")) {
        const k = cb.getAttribute("data-col")
        cb.checked = !!(prefs.cols && prefs.cols[k])
      }
    }

    function applyColumnVisibility() {
      const setCol = (el, colKey) => {
        if (!prefs.cols[colKey]) el.classList.add("col-hidden")
        else el.classList.remove("col-hidden")
      }

      for (const th of document.querySelectorAll("th[data-col]")) {
        setCol(th, th.getAttribute("data-col"))
      }

      for (const td of document.querySelectorAll("td[data-col]")) {
        setCol(td, td.getAttribute("data-col"))
      }
    }

    function renderHiddenList() {
      const list = [...hidden.values()].sort((a,b) => a.localeCompare(b))
      hiddenListEl.innerHTML = ""

      if (list.length === 0) {
        hiddenBox.style.display = "none"
        return
      }

      hiddenBox.style.display = ""
      for (const name of list) {
        const wrap = document.createElement("div")
        wrap.className = "pill"
        wrap.innerHTML =
          "<span>" + escapeHtml(name) + "</span>" +
          "<button type=\"button\" data-unhide=\"" + escapeHtml(name) + "\">Unhide</button>"
        hiddenListEl.appendChild(wrap)
      }
    }

    function cmp(a, b) {
      if (a === b) return 0
      if (a == null) return -1
      if (b == null) return 1
      return String(a).localeCompare(String(b))
    }

    function sortedRows(rows) {
      const key = prefs.sortKey || "trail"
      const mode = prefs.sortMode || "az"
      const dir = (mode === "za") ? -1 : 1

      const copy = rows.slice()
      copy.sort((ra, rb) => {
        const va = ra[key]
        const vb = rb[key]

        if (key === "closed") {
          const rank = v => v === "Yes" ? 2 : v === "Maybe" ? 1 : 0
          return dir * (rank(va) - rank(vb))
        }

        return dir * cmp(va, vb)
      })

      return copy
    }

    function ovKey(region, date) {
      return String(region || "") + "||" + String(date || "")
    }

    function getEffectiveForecast(region, date) {
      const k = ovKey(region, date)
      if (overrides.has(k)) return overrides.get(k)
      const m = forecastBase.get(region) || new Map()
      return m.get(date) || { rating: "-", tfbYes: false }
    }

    function renderIntoTbody(tbody, rowsForDay) {
      tbody.innerHTML = ""

      const term = q.value.toLowerCase()
      const list = sortedRows(rowsForDay)

      for (const r of list) {
        if (hidden.has(r.trail)) continue

        const tr = document.createElement("tr")
        tr.className = rowClass(r.closed)

        const trailCell =
          "<div class=\"trailcell\">" +
            "<span>" + escapeHtml(r.trail) + "</span>" +
            "<span class=\"trailactions\">" +
              (r.trailforks
                ? "<a href=\"" + escapeHtml(r.trailforks) + "\" target=\"_blank\" rel=\"noopener noreferrer\" aria-label=\"Open Trailforks\">" +
                    "<svg class=\"trailicon\" viewBox=\"0 0 300 300\" aria-hidden=\"true\">" +
                      "<use href=\"#trailforks-icon\"></use>" +
                    "</svg>" +
                  "</a>"
                : ""
              ) +
              (r.official
                ? "<a href=\"" + escapeHtml(r.official) + "\" target=\"_blank\" rel=\"noopener noreferrer\" aria-label=\"Official trail info\">" +
                    "<svg class=\"infoicon\" viewBox=\"0 0 24 24\" aria-hidden=\"true\">" +
                      "<use href=\"#info-icon\"></use>" +
                    "</svg>" +
                  "</a>"
                : ""
              ) +
              "<button type=\"button\" data-hide=\"" + escapeHtml(r.trail) + "\" aria-label=\"Hide trail\">" +
                "<svg class=\"trailicon\" viewBox=\"0 0 24 24\" aria-hidden=\"true\">" +
                  "<use href=\"#x-icon\"></use>" +
                "</svg>" +
              "</button>" +
            "</span>" +
          "</div>"

        tr.innerHTML =
          "<td data-col=\"trail\">" + trailCell + "</td>" +
          "<td data-col=\"region\">" + escapeHtml(r.region) + "</td>" +
          "<td data-col=\"owner\">" + escapeHtml(r.owner) + "</td>" +
          "<td data-col=\"fireDanger\">" + escapeHtml(r.fireDanger) + "</td>" +
          "<td data-col=\"fireBan\">" + escapeHtml(r.fireBan) + "</td>" +
          "<td data-col=\"closedOn\">" + escapeHtml(r.closedOn) + "</td>" +
          "<td data-col=\"closed\">" + escapeHtml(r.closed) + "</td>"

        if (term && !tr.textContent.toLowerCase().includes(term)) continue
        tbody.appendChild(tr)
      }
    }

    function renderAll() {
      const days = nextTwoDays()
      const today = days[0]
      const tomorrow = days[1]

      todayDateEl.textContent = today
      tomorrowDateEl.textContent = tomorrow

      const todayRows = allRows.filter(r => r.date === today)
      const tomorrowRows = allRows.filter(r => r.date === tomorrow)

      renderIntoTbody(tbodyToday, todayRows)
      renderIntoTbody(tbodyTomorrow, tomorrowRows)

      applyColumnVisibility()
    }

    function updateTestNote() {
      if (overrides.size === 0) {
        testNoteEl.textContent = "No test overrides applied"
        return
      }
      testNoteEl.textContent = "Active test overrides: " + overrides.size
    }

    function populateTestUi() {
      const regions = [...forecastBase.keys()].sort((a,b) => String(a).localeCompare(String(b)))
      testRegionEl.innerHTML = regions.map(r => "<option value=\"" + escapeHtml(r) + "\">" + escapeHtml(r) + "</option>").join("")

      const days = nextTwoDays()
      testDateEl.innerHTML = days.map(d => "<option value=\"" + escapeHtml(d) + "\">" + escapeHtml(d) + "</option>").join("")

      testBox.style.display = regions.length ? "" : "none"
      updateTestNote()
    }

    function rebuildRows() {
      const days = nextTwoDays()
      const rows = []

      for (const t of trailsData) {
        for (const d of days) {
          const f = getEffectiveForecast(t.region, d)
          const closed = computeClosed(f.tfbYes, f.rating, t.ban)

          rows.push({
            date: d,
            trail: t.name,
            region: t.region,
            owner: t.owner,
            fireDanger: f.rating,
            fireBan: f.tfbYes ? "Yes" : "No",
            closedOn: t.ban,
            closed,
            trailforks: t.trailforks || null,
            official: t.official || null
          })
        }
      }

      allRows = rows
      renderAll()
      setStatus("ok", "Loaded " + allRows.length + " rows")
    }

    function closeColsPanelIfClickOutside(e) {
      if (!colsPanel.classList.contains("open")) return
      const within = colsPanel.contains(e.target) || colsBtn.contains(e.target)
      if (!within) colsPanel.classList.remove("open")
    }

    document.addEventListener("click", closeColsPanelIfClickOutside)

    colsBtn.addEventListener("click", () => {
      colsPanel.classList.toggle("open")
    })

    colsPanel.addEventListener("change", e => {
      const cb = e.target.closest("input[type=checkbox][data-col]")
      if (!cb) return
      const k = cb.getAttribute("data-col")
      prefs.cols[k] = !!cb.checked
      savePrefs()
      applyColumnVisibility()
    })

    colsAll.addEventListener("click", () => {
      for (const k of Object.keys(prefs.cols)) prefs.cols[k] = true
      applyPrefsToUi()
      savePrefs()
      applyColumnVisibility()
    })

    colsNone.addEventListener("click", () => {
      for (const k of Object.keys(prefs.cols)) prefs.cols[k] = false
      prefs.cols.trail = true
      applyPrefsToUi()
      savePrefs()
      applyColumnVisibility()
    })

    sortKeyEl.addEventListener("change", () => {
      prefs.sortKey = sortKeyEl.value
      savePrefs()
      renderAll()
    })

    if (sortModeEl) {
      sortModeEl.addEventListener("change", () => {
        prefs.sortMode = sortModeEl.value
        savePrefs()
        renderAll()
      })
    }

    q.addEventListener("input", () => renderAll())

    document.addEventListener("click", e => {
      const btn = e.target.closest("button")
      if (!btn) return

      const hideName = btn.getAttribute("data-hide")
      if (hideName) {
        hidden.add(hideName)
        saveHidden()
        renderHiddenList()
        renderAll()
        setStatus("ok", "Loaded " + allRows.length + " rows")
        return
      }

      const unhideName = btn.getAttribute("data-unhide")
      if (unhideName) {
        hidden.delete(unhideName)
        saveHidden()
        renderHiddenList()
        renderAll()
        setStatus("ok", "Loaded " + allRows.length + " rows")
      }
    })

    unhideAllBtn.addEventListener("click", () => {
      hidden = new Set()
      saveHidden()
      renderHiddenList()
      renderAll()
      setStatus("ok", "Loaded " + allRows.length + " rows")
    })

    testApplyBtn.addEventListener("click", () => {
      const region = testRegionEl.value
      const date = testDateEl.value

      const tfbYes = !!testTfbEl.checked
      const rating = testRatingEl.value === "None" ? "-" : testRatingEl.value

      overrides.set(ovKey(region, date), { rating, tfbYes })
      updateTestNote()
      rebuildRows()
    })

    testResetBtn.addEventListener("click", () => {
      overrides.clear()
      updateTestNote()
      rebuildRows()
    })

    async function main() {
      try {
        hidden = loadHidden()
        renderHiddenList()

        const p = loadPrefs()
        if (p) {
          if (p.sortKey) prefs.sortKey = p.sortKey
          if (p.sortMode) prefs.sortMode = p.sortMode
          if (p.cols && typeof p.cols === "object") {
            for (const k of Object.keys(prefs.cols)) {
              if (k in p.cols) prefs.cols[k] = !!p.cols[k]
            }
          }
        }
        applyPrefsToUi()

        setStatus("warn", "Fetching trails.json")
        const trailsJson = await (await fetch(TRAILS_URL, { cache: "no-store" })).json()
        trailsData = Array.isArray(trailsJson.trails) ? trailsJson.trails : []

        setStatus("warn", "Fetching CFS XML")
        const xmlText = await (await fetch(XML_URL, { cache: "no-store" })).text()
        const xmlDoc = new DOMParser().parseFromString(xmlText, "application/xml")
        if (xmlDoc.querySelector("parsererror")) throw new Error("XML parse error")

        forecastBase = parseXml(xmlDoc)

        populateTestUi()
        rebuildRows()
      } catch (e) {
        setStatus("err", "Failed to load live data: " + e.message)
      }
    }

    main()
  </script>
</body>
</html>
